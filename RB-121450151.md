## Penyimpanan dan Akses Banyak Gambar di Python

### Pengaturan
#### Dataset yang Digunakan
Dataset CIFAR-10 terdiri dari 60.000 gambar berwarna dengan resolusi 32x32 piksel, dikelompokkan dalam sepuluh kelas objek seperti anjing, kucing, dan pesawat. Dataset ini dapat diunduh dalam format Python dan membutuhkan sekitar 163MB ruang disk. Gambar dalam dataset ini disimpan dalam file batch yang telah diserialisasi menggunakan cPickle.

#### Persiapan Penyimpanan Gambar
Instal beberapa pustaka yang diperlukan:
```bash
pip install pillow lmdb h5py
```

Buat direktori untuk setiap metode penyimpanan:
```bash
mkdir -p data/disk data/lmdb data/hdf5
```

Simpan jalur direktori dalam variabel Python:
```python
from pathlib import Path
disk_dir = Path("data/disk/")
lmdb_dir = Path("data/lmdb/")
hdf5_dir = Path("data/hdf5/")
```

### Penyimpanan Gambar Tunggal
#### Menyimpan Gambar ke Disk
Gunakan modul Pillow untuk menyimpan gambar dalam format `.png` dan menyimpan label dalam file `.csv`:
```python
from PIL import Image
import csv

def store_single_disk(image, image_id, label):
    Image.fromarray(image).save(disk_dir / f"{image_id}.png")
    with open(disk_dir / f"{image_id}.csv", "wt") as csvfile:
        writer = csv.writer(csvfile, delimiter=" ", quotechar="|", quoting=csv.QUOTE_MINIMAL)
        writer.writerow([label])
```

#### Menyimpan Gambar ke LMDB
LMDB adalah sistem penyimpanan data berbentuk kunci-nilai. Gunakan modul `pickle` untuk menyerialisasi gambar dan metadata:
```python
import lmdb
import pickle
import numpy as np

class CIFAR_Image:
    def __init__(self, image, label):
        self.channels = image.shape[2]
        self.size = image.shape[:2]
        self.image = image.tobytes()
        self.label = label

    def get_image(self):
        image = np.frombuffer(self.image, dtype=np.uint8)
        return image.reshape(*self.size, self.channels)

def store_single_lmdb(image, image_id, label):
    map_size = image.nbytes * 10
    env = lmdb.open(str(lmdb_dir / "single_lmdb"), map_size=map_size)
    with env.begin(write=True) as txn:
        value = CIFAR_Image(image, label)
        key = f"{image_id:08}"
        txn.put(key.encode("ascii"), pickle.dumps(value))
    env.close()
```

#### Menyimpan Gambar ke HDF5
HDF5 adalah format file yang dapat menyimpan lebih dari satu dataset dalam satu file:
```python
import h5py

def store_single_hdf5(image, image_id, label):
    file = h5py.File(hdf5_dir / f"{image_id}.h5", "w")
    file.create_dataset("image", data=image, dtype=h5py.h5t.STD_U8BE)
    file.create_dataset("meta", data=label, dtype=h5py.h5t.STD_U8BE)
    file.close()
```

### Eksperimen Penyimpanan Gambar Tunggal
Jalankan eksperimen untuk mengukur waktu yang diperlukan setiap metode untuk menyimpan satu gambar:
```python
from timeit import timeit

_store_single_funcs = {
    'disk': store_single_disk,
    'lmdb': store_single_lmdb,
    'hdf5': store_single_hdf5
}

store_single_timings = {}

for method in ("disk", "lmdb", "hdf5"):
    t = timeit(
        "_store_single_funcs[method](image, 0, label)",
        setup="image=images[0]; label=labels[0]",
        number=1,
        globals=globals(),
    )
    store_single_timings[method] = t
    print(f"Method: {method}, Time usage: {t}")
```

### Penyimpanan Banyak Gambar
#### Menyimpan Banyak Gambar ke Disk
```python
def store_many_disk(images, labels):
    for i, image in enumerate(images):
        Image.fromarray(image).save(disk_dir / f"{i}.png")
    with open(disk_dir / f"labels.csv", "w") as csvfile:
        writer = csv.writer(csvfile, delimiter=" ", quotechar="|", quoting=csv.QUOTE_MINIMAL)
        for label in labels:
            writer.writerow([label])
```

#### Menyimpan Banyak Gambar ke LMDB
```python
def store_many_lmdb(images, labels):
    map_size = len(images) * images[0].nbytes * 10
    env = lmdb.open(str(lmdb_dir / "many_lmdb"), map_size=map_size)
    with env.begin(write=True) as txn:
        for i, (image, label) in enumerate(zip(images, labels)):
            value = CIFAR_Image(image, label)
            key = f"{i:08}"
            txn.put(key.encode("ascii"), pickle.dumps(value))
    env.close()
```

#### Menyimpan Banyak Gambar ke HDF5
```python
def store_many_hdf5(images, labels):
    file = h5py.File(hdf5_dir / "many_images.h5", "w")
    file.create_dataset("images", data=images, dtype=h5py.h5t.STD_U8BE)
    file.create_dataset("meta", data=labels, dtype=h5py.h5t.STD_U8BE)
    file.close()
```

### Eksperimen Penyimpanan Banyak Gambar
Jalankan eksperimen untuk mengukur waktu yang diperlukan setiap metode untuk menyimpan banyak gambar:
```python
_store_many_funcs = {
    'disk': store_many_disk,
    'lmdb': store_many_lmdb,
    'hdf5': store_many_hdf5
}

cutoffs = [10, 100, 1000, 10000, 100000]
images = np.concatenate((images, images), axis=0)
labels = np.concatenate((labels, labels), axis=0)

store_many_timings = {"disk": [], "lmdb": [], "hdf5": []}

for cutoff in cutoffs:
    for method in ("disk", "lmdb", "hdf5"):
        t = timeit(
            "_store_many_funcs[method](images_[:cutoff], labels_[:cutoff])",
            setup="images_=images; labels_=labels",
            number=1,
            globals=globals(),
        )
        store_many_timings[method].append(t)
        print(f"Method: {method}, Cutoff: {cutoff}, Time usage: {t}")
```

### Membaca Gambar Tunggal
#### Membaca dari Disk
```python
def read_single_disk(image_id):
    image = np.array(Image.open(disk_dir / f"{image_id}.png"))
    with open(disk_dir / f"{image_id}.csv", "r") as csvfile:
        reader = csv.reader(csvfile, delimiter=" ", quotechar="|", quoting=csv.QUOTE_MINIMAL)
        label = int(next(reader)[0])
    return image, label
```

#### Membaca dari LMDB
```python
def read_single_lmdb(image_id):
    env = lmdb.open(str(lmdb_dir / "single_lmdb"), readonly=True)
    with env.begin() as txn:
        data = txn.get(f"{image_id:08}".encode("ascii"))
        cifar_image = pickle.loads(data)
        image = cifar_image.get_image()
        label = cifar_image.label
    env.close()
    return image, label
```

#### Membaca dari HDF5
```python
def read_single_hdf5(image_id):
    file = h5py.File(hdf5_dir / f"{image_id}.h5", "r")
    image = np.array(file["image"]).astype("uint8")
    label = int(np.array(file["meta"]).astype("uint8"))
    file.close()
    return image, label
```

### Eksperimen Membaca Gambar Tunggal
Jalankan eksperimen untuk mengukur waktu yang diperlukan setiap metode untuk membaca satu gambar:
```python
_read_single_funcs = {
    'disk': read_single_disk,
    'lmdb': read_single_lmdb,
    'hdf5': read_single_hdf5
}

read_single_timings = {}

for method in ("disk", "lmdb", "hdf5"):
    t = timeit(
        "_read_single_funcs ",
        setup="image=images[0]; label=labels[0]",
        number=1,
        globals=globals(),
    )
    read_single_timings[method] = t
    print(f"Method: {method}, Time usage: {t}")
```

### Kesimpulan
- Membaca dan menulis gambar secara langsung dari/ke disk biasanya lebih cepat untuk jumlah gambar kecil.
- Metode penyimpanan seperti LMDB dan HDF5 lebih efisien saat bekerja dengan dataset yang lebih besar.
- Setiap metode memiliki kelebihan dan kekurangan tergantung pada skenario penggunaan.

Semoga ini membantu dalam memahami dan mengimplementasikan berbagai metode penyimpanan gambar di Python!
